<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EGN Members Payment Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%); }
        .header { background: linear-gradient(90deg, #dc2626 0%, #f97316 50%, #eab308 100%); color: white; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; }
        .logo-section { display: flex; align-items: center; gap: 1rem; }
        .logo { width: 64px; height: 64px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        h1 { font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #dc2626 0%, #f97316 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); }
        .btn-success { background: #16a34a; color: white; font-size: 0.875rem; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-outline { background: white; color: #2563eb; border: 2px solid #2563eb; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; }
        .member-card { background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1rem; overflow: hidden; transition: all 0.3s; border: 1px solid #e5e7eb; position: relative; }
        .member-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .delete-member-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: #dc2626; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.2s; }
        .delete-member-btn:hover { background: #991b1b; transform: scale(1.1); }
        .member-main { padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 1rem; }
        .member-main:hover { background: #f9fafb; }
        .member-photo { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #f97316; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .member-photo-placeholder { width: 56px; height: 56px; border-radius: 50%; background: linear-gradient(135deg, #fb923c 0%, #dc2626 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; }
        .member-info { flex: 1; min-width: 0; }
        .member-name { font-size: 1.125rem; font-weight: 700; color: #111827; margin-bottom: 0.25rem; }
        .member-date { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem; }
        .member-amount { font-size: 1.25rem; font-weight: 700; color: #16a34a; }
        .member-status { display: flex; align-items: center; gap: 0.75rem; }
        .checkbox { width: 24px; height: 24px; cursor: pointer; accent-color: #16a34a; }
        .expand-icon { width: 20px; height: 20px; color: #9ca3af; transition: transform 0.3s; }
        .expand-icon.expanded { transform: rotate(180deg); }
        .member-details { border-top: 1px solid #e5e7eb; background: #f9fafb; padding: 1rem; display: none; }
        .member-details.show { display: block; }
        .payment-history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .payment-item { background: white; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 0.5rem; }
        .payment-item-header { display: flex; justify-content: space-between; align-items: start; }
        .payment-amount { font-weight: 700; color: #16a34a; }
        .payment-date { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
        .badge { display: inline-block; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .badge-paid { background: #dcfce7; color: #166534; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; }
        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; }
        .form-input:focus { outline: none; border-color: #f97316; box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1); }
        .form-buttons 
        { display: flex;
           gap: 0.75rem;
           margin-top: 1.5rem;
         }
        .empty-state { text-align: center; padding: 4rem 1rem; }
        .empty-icon { font-size: 4rem; margin-bottom: 1rem; }
        .empty-title { font-size: 1.5rem; font-weight: 700; color: #111827; margin-bottom: 0.5rem; }
        .empty-text { color: #6b7280; }
        .payment-actions { display: flex; gap: 0.5rem; }
        .btn-icon { padding: 0.5rem; border: none; background: transparent; cursor: pointer; border-radius: 0.25rem; transition: background 0.2s; font-size: 1.2rem; }
        .btn-icon:hover { background: #f3f4f6; }
        .add-payment-form { background: white; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; margin-bottom: 1rem; }
        .photo-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-top: 0.5rem; border: 2px solid #f97316; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .spinner-overlay.show { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid #ffffff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @media (max-width: 640px) {
            h1 { font-size: 1.25rem; }
            .logo { width: 48px; height: 48px; }
            .header-content { flex-direction: column; align-items: stretch; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div id="spinnerOverlay" class="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <img src="https://qtrypzzcjebvfcihiynt.supabase.co/storage/v1/object/public/base44-prod/public/user_68f562d230fb0eb3eadf046f/1fe3ed115_Illuminati_Eye_with_South_African_Flag.png" alt="EGN Logo" class="logo">
                <h1>EGN MEMBERS PAYMENT PORTAL</h1>
            </div>
            <button class="btn btn-primary" onclick="openAddMemberModal()">
                <span>➕</span> Add New Member
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div id="membersList"></div>
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">👥</div>
            <div class="empty-title">No Members Yet</div>
            <div class="empty-text">Click "Add New Member" to get started</div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Add New Member</div>
            <form id="addMemberForm" onsubmit="handleAddMember(event)">
                <div class="form-group">
                    <label class="form-label">Member Photo</label>
                    <input type="file" accept="image/*" class="form-input" id="photoFile" onchange="previewPhoto()">
                    <img id="photoPreview" class="photo-preview" style="display: none;">
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="memberName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Amount (R)</label>
                    <input type="number" step="0.01" class="form-input" id="paymentAmount" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Payment Date</label>
                    <input type="date" class="form-input" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="isPaid" class="checkbox">
                        <span>Payment Received</span>
                    </label>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-outline" onclick="closeAddMemberModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-success" style="flex: 1;" id="submitBtn">
                        Add Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // ==========================================
        // STEP 1: IMPORT FIREBASE LIBRARIES
        // These are the Firebase SDKs we need
        // ==========================================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        // ==========================================
        // STEP 2: YOUR FIREBASE CONFIGURATION
        // This connects to YOUR Firebase project
        // ==========================================
       const firebaseConfig = {
    apiKey: "AIzaSyDDMsvRTz9nPGDk8Ob_FPRc5Boov2FVt9w",
    authDomain: "egn-portal.firebaseapp.com",
    projectId: "egn-portal",
    storageBucket: "egn-portal.appspot.com", // ✅ FIXED
    messagingSenderId: "88252271549",
    appId: "1:88252271549:web:80aa211a420e205c1720d4",
    measurementId: "G-KYMBME9RDQ"
     };
        // ==========================================
        // STEP 3: INITIALIZE FIREBASE
        // This starts up Firebase with your config
        // ==========================================
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);        // Database for storing member/payment data
        const storage = getStorage(app);     // Storage for storing photos

        // ==========================================
        // GLOBAL VARIABLES
        // ==========================================
        let members = [];
        let currentPhotoFile = null;

        // ==========================================
        // HELPER FUNCTIONS
        // ==========================================
        function showSpinner() {
            document.getElementById('spinnerOverlay').classList.add('show');
        }

        function hideSpinner() {
            document.getElementById('spinnerOverlay').classList.remove('show');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        // ==========================================
        // STEP 4: UPLOAD PHOTO TO FIREBASE STORAGE
        // This uploads the image file and returns URL
        // ==========================================
        async function uploadPhoto(file) {
            if (!file) return null;
            
            // Create a unique filename using timestamp
            const filename = `members/${Date.now()}_${file.name}`;
            
            // Create a reference to where the file will be stored
            const storageRef = ref(storage, filename);
            
            // Upload the file
            await uploadBytes(storageRef, file);
            
            // Get the download URL so we can display the image later
            const downloadURL = await getDownloadURL(storageRef);
            
            return downloadURL;
        }

        // ==========================================
        // STEP 5: LOAD ALL MEMBERS FROM FIRESTORE
        // This fetches all members from the database
        // ==========================================
        async function loadMembers() {
            try {
                showSpinner();
                
                // Query Firestore for all members, ordered by payment date
                const membersRef = collection(db, 'members');
                const q = query(membersRef, orderBy('payment_date', 'desc'));
                const querySnapshot = await getDocs(q);
                
                // Convert Firestore documents to JavaScript objects
                members = querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                renderMembers();
                hideSpinner();
            } catch (error) {
                console.error('Error loading members:', error);
                alert('Error loading members: ' + error.message);
                hideSpinner();
            }
        }

        // ==========================================
        // STEP 6: LOAD PAYMENTS FOR A MEMBER
        // This fetches payment history for one member
        // ==========================================
        async function loadPayments(memberId) {
            try {
                const paymentsRef = collection(db, 'payments');
                const q = query(paymentsRef, where('member_id', '==', memberId), orderBy('payment_date', 'desc'));
                const querySnapshot = await getDocs(q);
                
                return querySnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
            } catch (error) {
                console.error('Error loading payments:', error);
                return [];
            }
        }

        // ==========================================
        // RENDER FUNCTIONS
        // ==========================================
        async function renderMembers() {
            const membersList = document.getElementById('membersList');
            const emptyState = document.getElementById('emptyState');

            if (members.length === 0) {
                membersList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            
            // Load payments for each member and render
            const memberCards = await Promise.all(members.map(async (member) => {
                const memberPayments = await loadPayments(member.id);
                return `
                    <div class="member-card">
                        <button class="delete-member-btn" onclick="deleteMember('${member.id}')" title="Delete Member">
                            🗑️
                        </button>
                        <div class="member-main" onclick="toggleDetails('${member.id}')">
                            <div>
                                ${member.photo_url ? 
                                    `<img src="${member.photo_url}" class="member-photo" alt="${member.name}">` :
                                    `<div class="member-photo-placeholder">${member.name.charAt(0).toUpperCase()}</div>`
                                }
                            </div>
                            <div class="member-info">
                                <div class="member-name">${member.name}</div>
                                <div class="member-date">${formatDate(member.payment_date)}</div>
                                <div class="member-amount">R ${parseFloat(member.payment_amount).toFixed(2)}</div>
                            </div>
                            <div class="member-status">
                                <input type="checkbox" class="checkbox" ${member.is_paid ? 'checked' : ''} 
                                    onclick="event.stopPropagation(); toggleMemberPaid('${member.id}', ${!member.is_paid})" />
                                <svg class="expand-icon" id="icon-${member.id}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <div class="member-details" id="details-${member.id}">
                            <div class="payment-history-header">
                                <h4 style="font-weight: 700;">Payment History</h4>
                                <button class="btn btn-success" onclick="showAddPaymentForm('${member.id}')">
                                    ➕ Add Payment
                                </button>
                            </div>
                            <div id="add-payment-${member.id}" style="display: none;" class="add-payment-form">
                                <div class="form-group">
                                    <input type="number" step="0.01" class="form-input" id="new-amount-${member.id}" placeholder="Amount">
                                </div>
                                <div class="form-group">
                                    <input type="date" class="form-input" id="new-date-${member.id}">
                                </div>
                                <div class="form-group">
                                    <input type="text" class="form-input" id="new-notes-${member.id}" placeholder="Notes (optional)">
                                </div>
                                <button class="btn btn-success" style="width: 100%;" onclick="addPayment('${member.id}')">
                                    Save Payment
                                </button>
                            </div>
                            <div id="payments-${member.id}">
                                ${memberPayments.length === 0 ? 
                                    '<p style="text-align: center; color: #9ca3af; padding: 2rem; font-size: 0.875rem;">No payment history yet</p>' :
                                    memberPayments.map(payment => `
                                        <div class="payment-item">
                                            <div class="payment-item-header">
                                                <div style="flex: 1;">
                                                    <div>
                                                        <span class="payment-amount">R ${parseFloat(payment.amount).toFixed(2)}</span>
                                                        ${payment.is_paid ? '<span class="badge badge-paid" style="margin-left: 0.5rem;">PAID</span>' : ''}
                                                    </div>
                                                    <div class="payment-date">${formatDate(payment.payment_date)}</div>
                                                    ${payment.notes ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${payment.notes}</div>` : ''}
                                                </div>
                                                <div class="payment-actions">
                                                    <button class="btn-icon" onclick="deletePayment('${payment.id}', '${member.id}')" title="Delete">
                                                        🗑️
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')
                                }
                            </div>
                        </div>
                    </div>
                `;
            }));
            
            membersList.innerHTML = memberCards.join('');
        }

        // ==========================================
        // STEP 7: ADD NEW MEMBER TO FIRESTORE
        // This saves a new member to the database
        // ==========================================
        window.handleAddMember = async function(event) {
            event.preventDefault();
            
            try {
                showSpinner();
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                
                // Upload photo if one was selected
                let photoURL = null;
                if (currentPhotoFile) {
                    photoURL = await uploadPhoto(currentPhotoFile);
                }
                
                // Create the member object
                const newMember = {
                    name: document.getElementById('memberName').value,
                    photo_url: photoURL,
                    payment_amount: parseFloat(document.getElementById('paymentAmount').value),
                    payment_date: document.getElementById('paymentDate').value,
                    is_paid: document.getElementById('isPaid').checked,
                    created_date: serverTimestamp()
                };

                // Add to Firestore
                await addDoc(collection(db, 'members'), newMember);
                
                // Reload and close modal
                await loadMembers();
                closeAddMemberModal();
                hideSpinner();
                submitBtn.disabled = false;
            } catch (error) {
                console.error('Error adding member:', error);
                alert('Error adding member: ' + error.message);
                hideSpinner();
                document.getElementById('submitBtn').disabled = false;
            }
        };

        // ==========================================
        // STEP 8: UPDATE MEMBER PAID STATUS
        // This updates whether a member has paid
        // ==========================================
        window.toggleMemberPaid = async function(memberId, isPaid) {
            try {
                showSpinner();
                const memberRef = doc(db, 'members', memberId);
                await updateDoc(memberRef, { is_paid: isPaid });
                await loadMembers();
                hideSpinner();
            } catch (error) {
                console.error('Error updating member:', error);
                alert('Error updating member: ' + error.message);
                hideSpinner();
            }
        };

        // ==========================================
        // STEP 9: DELETE MEMBER FROM FIRESTORE
        // This removes a member from the database
        // ==========================================
        window.deleteMember = async function(memberId) {
            if (!confirm('Are you sure you want to delete this member? This will also delete all their payment history.')) {
                return;
            }
            
            try {
                showSpinner();
                
                // Delete all payments for this member first
                const paymentsRef = collection(db, 'payments');
                const q = query(paymentsRef, where('member_id', '==', memberId));
                const querySnapshot = await getDocs(q);
                
                for (const paymentDoc of querySnapshot.docs) {
                    await deleteDoc(doc(db, 'payments', paymentDoc.id));
                }
                
                // Then delete the member
                await deleteDoc(doc(db, 'members', memberId));
                
                await loadMembers();
                hideSpinner();
            } catch (error) {
                console.error('Error deleting member:', error);
                alert('Error deleting member: ' + error.message);
                hideSpinner();
            }
        };

        // ==========================================
        // STEP 10: ADD PAYMENT TO FIRESTORE
        // This adds a payment record for a member
        // ==========================================
        window.addPayment = async function(memberId) {
            const amount = document.getElementById('new-amount-' + memberId).value;
            const date = document.getElementById('new-date-' + memberId).value;
            const notes = document.getElementById('new-notes-' + memberId).value;

            if (!amount || !date) {
                alert('Please fill in amount and date');
                return;
            }

            try {
                showSpinner();
                
                const newPayment = {
                    member_id: memberId,
                    amount: parseFloat(amount),
                    payment_date: date,
                    notes: notes,
                    is_paid: true,
                    created_date: serverTimestamp()
                };

                await addDoc(collection(db, 'payments'), newPayment);
                
                // Clear form
                document.getElementById('new-amount-' + memberId).value = '';
                document.getElementById('new-date-' + memberId).value = '';
                document.getElementById('new-notes-' + memberId).value = '';
                document.getElementById('add-payment-' + memberId).style.display = 'none';
                
                await loadMembers();
                hideSpinner();
            } catch (error) {
                console.error('Error adding payment:', error);
                alert('Error adding payment: ' + error.message);
                hideSpinner();
            }
        };

        // ==========================================
        // STEP 11: DELETE PAYMENT FROM FIRESTORE
        // This removes a payment record
        // ==========================================
        window.deletePayment = async function(paymentId, memberId) {
            if (!confirm('Delete this payment?')) return;
            
            try {
                showSpinner();
                await deleteDoc(doc(db, 'payments', paymentId));
                await loadMembers();
                hideSpinner();
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('Error deleting payment: ' + error.message);
                hideSpinner();
            }
        };

        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        window.toggleDetails = function(memberId) {
            const details = document.getElementById('details-' + memberId);
            const icon = document.getElementById('icon-' + memberId);
            
            if (details.classList.contains('show')) {
                details.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                details.classList.add('show');
                icon.classList.add('expanded');
            }
        };

        window.openAddMemberModal = function() {
            document.getElementById('addMemberModal').classList.add('show');
        };

        window.closeAddMemberModal = function() {
            document.getElementById('addMemberModal').classList.remove('show');
            document.getElementById('addMemberForm').reset();
            document.getElementById('photoPreview').style.display = 'none';
            currentPhotoFile = null;
        };

        window.showAddPaymentForm = function(memberId) {
            const form = document.getElementById('add-payment-' + memberId);
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        };

        window.previewPhoto = function() {
            const fileInput = document.getElementById('photoFile');
            const preview = document.getElementById('photoPreview');
            
            if (fileInput.files && fileInput.files[0]) {
                currentPhotoFile = fileInput.files[0];
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        };

        // Close modal when clicking outside
        document.getElementById('addMemberModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddMemberModal();
        });

        // ==========================================
        // INITIALIZE APP - LOAD DATA ON START
        // ==========================================
        loadMembers();
    </script>
</body>
</html>
